(function(){function p(a,b){var c,d;switch(a){case "css":c="LINK";d={rel:"stylesheet",type:"text/css",href:b};break;case "js":c="SCRIPT",d={type:"text/javascript",src:b}}c=document.createElement(c);document.querySelector("head").appendChild(c);for(var f in d)c[f]=d[f]}function d(a,b){var c;c=RegExp("<(.|\n)*?>","g");a instanceof Element?c=Array(a):c.test(a)?(c=document.createElement("div"),c.innerHTML=a,c=Array(c.firstChild)):c=(b||document).querySelectorAll(a);return new m(c)}function m(a,b){this._nodes=
a}function g(a,b,c){var e,f=a?d("#"+a):"";switch(c){case "button-link":e='<a type="button"'+(a?' id="'+a+'"':"")+' class="button"><span></span></a>';break;case "layer":e="<div"+(a?' id="'+a+'"':"")+"></div>";break;case "input-text":e='<input type="text"'+(a?' id="'+a+'"':"")+"/>";break;case "input-textarea":e='<textarea type="text"'+(a?' id="'+a+'"':"")+'"></textarea>'}a&&f.node(0)||(f=d(e).appendTo(d(b).node(0)));return f}function q(a,b){this.onEnterFullScreen=a;this.onExitFullScreen=b;this._init()}
function r(a,b){this._node=a;this._members={};this._isSharingOn=!1;this._screenStream=this._webcamStream=void 0;this._isPluginUsed=bc.isWebRTCPluginUsed();this._options={appId:void 0,appKey:void 0,room:void 0,callee:void 0,id:void 0,name:"user",device:"webcam-sd",debug:!1,extid:!1,"chrome-ext-id":!1,"firefox-ext-id":!1,"media-controls":!1,chat:!1,capacity:4};for(opt in b)this._options.hasOwnProperty(opt)&&void 0!==b[opt]&&(this._options[opt]=b[opt]);10<this._options.capacity&&(this._options.capacity=
10);this._options.appId&&this._options.appKey&&this._options.room&&(this.fullScreen=new q(null,function(a){d(".full-screen").removeClass("full-screen")}),this._init())}var l,n;BISTRI_EXTENSION_INSTALLATION="Please wait, the screen sharing extension is being installed";BISTRI_EXTENSION_RELOAD="Reload Page";BISTRI_PLUGIN_TEXT='A plugin is required: click "Download" and install WebRTC plugin to enjoy video conferencing right from your browser.';BISTRI_PLUGIN_DOWNLOAD="Download";BISTRI_PLUGIN_CANCEL=
"Cancel";m.prototype={node:function(a){return"number"!==typeof a?null:this._nodes[a]||null},count:function(){return this._nodes.length},val:function(a){if("undefined"!==typeof this._nodes[0].value)return"undefined"!==typeof a?(this._nodes[0].value=a,this):this._nodes[0].value},html:function(a){this._nodes[0]&&(this._nodes[0].innerHTML=a);return this},show:function(){this._forEach(function(a){a.style.display=""});return this},hide:function(){this._forEach(function(a){a.style.display="none"});return this},
hasClass:function(a){return this._nodes[0]?-1!=this._nodes[0].getAttribute("class").indexOf(a)?!0:!1:!1},addClass:function(a){this._forEach(function(b){var c=b.getAttribute("class");cssArray=c?c.split(" "):[];-1==cssArray.indexOf(a)&&(cssArray.push(a),b.setAttribute("class",cssArray.join(" ")))});return this},removeClass:function(a){this._forEach(function(b){var c=b.getAttribute("class");c&&(cssArray=c.split(" "),c=cssArray.indexOf(a),-1!=c&&(cssArray.splice(c,1),b.setAttribute("class",cssArray.join(" "))))});
return this},on:function(a,b){this._forEach(function(c){c.addEventListener(a,b.bind(this))}.bind(this));return this},appendNode:function(a){this._nodes[0]&&this._nodes[0].appendChild(a instanceof m?a.node(0):a);return this},appendTo:function(a){this._nodes[0]&&(a instanceof m?a.node(0):a).appendChild(this._nodes[0]);return this},remove:function(){this._nodes[0]&&this._nodes[0].parentNode.removeChild(this._nodes[0]);return this},setAttr:function(a,b){this._forEach(function(c){c.setAttribute(a,b)});
return this},removeAttr:function(a){this._forEach(function(b){b.removeAttribute(a)});return this},style:function(a,b){if(b)this._forEach(function(c){c.style[a]=b});else return this._nodes[0].style[a];return this},props:function(){if(this._nodes[0]){var a=window.getComputedStyle(this._nodes[0]);return{width:parseInt(this._nodes[0].offsetWidth),height:parseInt(this._nodes[0].offsetHeight),top:parseInt(a.getPropertyValue("top")),left:parseInt(a.getPropertyValue("left"))}}return null},foreach:function(a){this._forEach(a);
return this},_forEach:function(a){for(var b=0,c=this._nodes.length;b<c;b++)"function"===typeof a&&a(this._nodes[b],b)},getCss:function(a){if(this._nodes[0])return window.getComputedStyle(this._nodes[0]).getPropertyValue(a)},scrollTo:function(a){if(this._nodes[0])switch(a){case "top":this._nodes[0].scrollTop=0;break;case "bottom":this._nodes[0].scrollTop=this._nodes[0].scrollHeight;break;default:a=parseInt(a),isNaN(a)||(this._nodes[0].scrollTop=a)}},enterFullScreen:function(){this._nodes[0]&&(this._nodes[0].requestFullScreen||
this._nodes[0].webkitRequestFullScreen||this._nodes[0].mozRequestFullScreen).call(this._nodes[0]);return this},exitFullScreen:function(){this._nodes[0]&&(document.cancelFullScreen||document.webkitCancelFullScreen||document.mozCancelFullScreen||document.oCancelFullScreen).call(document);return this}};q.prototype={_screenChangeEvents:["fullscreenchange","webkitfullscreenchange","mozfullscreenchange","MSFullscreenChange"],_init:function(){this._screenChangeEvents.forEach(function(a){document.addEventListener(a,
function(a){if(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement){if("function"===typeof this.onEnterFullScreen)this.onEnterFullScreen(a.srcElement)}else if("function"===typeof this.onExitFullScreen)this.onExitFullScreen(a.srcElement)}.bind(this))}.bind(this))},enterFullScreen:function(a){(a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen||a.msRequestFullscreen).call(a)},exitFullScreen:function(){(document.msExitFullscreen||
document.webkitCancelFullScreen||document.mozCancelFullScreen||document.cancelFullScreen||document.exitFullscreen).call(document)},isCompatible:function(){return document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled?!0:!1}};r.prototype={_init:function(){bc.init({appId:this._options.appId,appKey:this._options.appKey,userId:this._options.id,userName:this._options.name,debug:this._options.debug,chromeExtensionId:this._options.extid||
this._options["chrome-ext-id"],firefoxExtensionId:this._options["firefox-ext-id"],extAutoReload:!1});bc.signaling.bind("onConnected",this._connected.bind(this));bc.signaling.bind("onJoinedRoom",this._joinedRoom.bind(this));bc.signaling.bind("onError",this._error.bind(this));bc.signaling.bind("onPeerJoinedRoom",this._peerJoinedRoom.bind(this));bc.signaling.bind("onPeerQuittedRoom",this._peerQuittedRoom.bind(this));bc.signaling.bind("onExtensionInstalled",this._extensionInstalled.bind(this));bc.signaling.bind("onExtensionInstallStarted",
this._extensionInstallStarted.bind(this));bc.streams.bind("onStreamAdded",this._streamAdded.bind(this));bc.streams.bind("onStreamClosed",this._streamClosed.bind(this));bc.streams.bind("onStreamMuteChange",this._streamMuteChange.bind(this));g("bistri-videos",".bistri-conference","layer");g("bistri-bar",".bistri-conference","layer");g("bistri-videos-feedback","#bistri-bar","layer");this._resizeVideoFeedback();if(this._options["media-controls"]){g("bistri-controls","#bistri-bar","layer");g("bistri-mute-mic",
"#bistri-controls","button-link").on("click",this._toggleMic.bind(this)).show()[bc.isMicrophoneMuted()?"removeClass":"addClass"]("on");if(-1==this._options.device.indexOf("audio"))g("bistri-mute-webcam","#bistri-controls","button-link").on("click",this._toggleWebcam.bind(this)).show()[bc.isVideoMuted()?"removeClass":"addClass"]("on");g("bistri-mute-sound","#bistri-controls","button-link").on("click",this._toggleSound.bind(this)).show()[bc.isAllSoundsMuted()?"removeClass":"addClass"]("on")}(this._options.extid||
this._options["chrome-ext-id"]||this._options["firefox-ext-id"])&&bc.isScreenSharingCompatible()&&(g("bistri-controls","#bistri-bar","layer"),g("bistri-screen-sharing","#bistri-controls","button-link").on("click",this._toggleScreenSharing.bind(this)).show());this._options.chat&&(g("bistri-chat","#bistri-bar","layer"),g("bistri-chat-messages","#bistri-chat","layer").addClass("inactive"),g("bistri-chat-input","#bistri-chat","input-textarea").on("keydown",this._sendChatMessage.bind(this)).setAttr("readonly",
"readonly").addClass("inactive").show(),bc.channels.bind("onDataChannelCreated",this._setDataChannel.bind(this)),bc.channels.bind("onDataChannelRequested",this._setDataChannel.bind(this)),this._resizeChat());bc.connect()},_connected:function(a){bc.isCompatible()?this._webcamStream?bc.signaling.joinRoom(this._options.room,this._options.capacity):bc.startStream(this._options.device,function(a,c){this._webcamStream=a;bc.muteVideo(a,bc.isVideoMuted());bc.muteMicrophone(bc.isMicrophoneMuted());this._insertStream(a,
c,"#bistri-videos-feedback");this._resizeVideo("#bistri-videos-feedback div[id^=bistri-id]");bc.signaling.joinRoom(this._options.room,this._options.capacity)}.bind(this)):bc.isWebRTCPluginAvailable()&&this._downloadPlugin()},_joinedRoom:function(a){function b(){for(user in c._members)bc.call(c._members[user].id,c._options.room),c._options.chat&&bc.openDataChannel(c._members[user].id,"chat",c._options.room);c._options.callee&&c._options.callee.split(",").forEach(function(a){a in c._members||(bc.call(a,
c._options.room),c._options.chat&&bc.openDataChannel(a,"chat",c._options.room))})}var c=this;if(-1!=a.room.indexOf("__screen_"))b();else{for(var d=0;d<a.members.length;d++)this._members[a.members[d].id]=a.members[d];this._options.extid||this._options["chrome-ext-id"]||this._options["firefox-ext-id"]?bc.signaling.joinRoom("__screen_"+this._options.room,this._options.capacity):b()}},_error:function(a){a&&a.error&&console.log(a.error)},_peerJoinedRoom:function(a){-1==a.room.indexOf("__screen_")?this._members[a.pid]=
{id:a.pid,name:a.name,room:a.room}:this._isSharingOn&&this._screenStream&&bc.call(a.pid,"__screen_"+this._options.room,{sendonly:!0,stream:this._screenStream})},_peerQuittedRoom:function(a){-1==a.room.indexOf("__screen_")&&delete this._members[a.pid]},_streamAdded:function(a,b){this._insertStream(a,b,"#bistri-videos")},_streamClosed:function(a,b){"screen-sharing"==a.type&&(bc.endCalls("__screen_"+this._options.room),this._isSharingOn=!1,this._screenStream=void 0,d("#bistri-screen-sharing").removeClass("on"));
this._removeStream(a,b)},_streamMuteChange:function(a,b){d("#bistri-id-"+b)[a?"addClass":"removeClass"]("muted")},_toggleScreenSharing:function(){var a=d("#bistri-screen-sharing");d("#bistri-screen-sharing").hasClass("disabled")||(this._isSharingOn?(bc.endCalls("__screen_"+this._options.room),bc.stopStream(this._screenStream,function(b,c){this._removeStream(b,c);this._isSharingOn=!1;this._screenStream=void 0;a.removeClass("on")}.bind(this))):bc.startStream("screen-sharing",function(b,c){this._isSharingOn=
!0;this._screenStream=b;a.addClass("on");this._insertStream(this._screenStream,c,"#bistri-videos-feedback");for(member in this._members)bc.call(this._members[member].id,"__screen_"+this._options.room,{sendonly:!0,stream:this._screenStream})}.bind(this)))},_toggleWebcam:function(){if(this._webcamStream){var a=d("#bistri-mute-webcam");bc.muteVideo(this._webcamStream,!bc.isVideoMuted());a[bc.isVideoMuted()?"removeClass":"addClass"]("on")}},_toggleSound:function(){var a=d("#bistri-mute-sound");bc.getRemoteStreams(this._options.room);
bc.muteAllSounds(!bc.isAllSoundsMuted());a[bc.isAllSoundsMuted()?"removeClass":"addClass"]("on")},_toggleMic:function(){if(this._webcamStream){var a=d("#bistri-mute-mic");bc.muteMicrophone(!bc.isMicrophoneMuted());a[bc.isMicrophoneMuted()?"removeClass":"addClass"]("on")}},_setDataChannel:function(a,b){bc.isWebRTCPluginUsed()&&(b in this._members&&(this._members[b].channel=a),this._isAvailableForChat()&&(d("#bistri-chat-messages").removeClass("inactive"),d("#bistri-chat-input").removeAttr("readonly").removeClass("inactive")));
a.onOpen=function(c){b in this._members&&(this._members[b].channel=a);this._isAvailableForChat()&&(d("#bistri-chat-messages").removeClass("inactive"),d("#bistri-chat-input").removeAttr("readonly").removeClass("inactive"))}.bind(this);a.onClose=function(a){b in this._members&&delete this._members[b].channel;this._isAvailableForChat()||(d("#bistri-chat-messages").addClass("inactive"),d("#bistri-chat-input").setAttr("readonly","readonly").addClass("inactive"))}.bind(this);a.onMessage=function(a){this._displayChatMessage("local",
this._members[b].name,a.data)}.bind(this)},_displayChatMessage:function(a,b,c){var e=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|]\.(jpg|jpeg|png|gif))/gim;c=c.trim().replace(/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;{}\"']*[-A-Z0-9+&@#\/%=~_|{}\"':])/gim,function(a){return a.match(e)?'<a href="'+a+'" target="_blank"><img src="'+a+'"/></a>':'<a href="'+a+'" target="_blank">'+a+"</a>"});a='<div class="'+a+'">'+b+" : "+c+"</div>";d("#bistri-chat-messages").appendNode(d(a).node(0)).scrollTo("bottom")},
_isAvailableForChat:function(){var a=!1;for(member in this._members)"channel"in this._members[member]&&(a=!0);return a},_sendChatMessage:function(a){if(13==a.keyCode&&!a.shiftKey){var b=d("#bistri-chat-input"),c;for(c in this._members)"channel"in this._members[c]&&b.val()&&this._members[c].channel.send(b.val());this._displayChatMessage("remote",this._options.name,b.val());b.val("");a.preventDefault()}},_insertStream:function(a,b,c){var e=!!a.type,f=!!a.room,k=e&&"screen-sharing"==a.type||f&&0==a.room.indexOf("__screen_"),
h=g("bistri-id-"+b,c,"layer");c={autoplay:!0,mirror:e&&!k?!0:!1};!d(".bistri-toggle-fullscreen",h.node(0)).node(0)&&f&&this.fullScreen.isCompatible()&&g(void 0,h.node(0),"layer").on("click",function(){h.hasClass("full-screen")?this.fullScreen.exitFullScreen(h.node(0)):(h.addClass("full-screen"),this.fullScreen.enterFullScreen(h.node(0)))}.bind(this)).addClass("bistri-toggle-fullscreen");f=g(void 0,h.node(0),"layer").addClass("bistri-no-video");g(void 0,f.node(0),"layer").addClass("bistri-no-video-inner");
this._hasVideoTracks(a)||h.addClass("no-video");this._isPluginUsed?(b=g("bistri-object-"+a.id.substr(0,8),"#bistri-id-"+b,"layer").addClass("video-wrapper"),bc.attachStream(a,b.node(0),c),b.addClass(k?"screen-stream":"regular-stream")):(a=bc.attachStream(a,h.node(0),c),d(a).addClass(k?"screen-stream":"regular-stream"));k=d("#bistri-videos > div").count();1<k&&4>=k?d("#bistri-videos").addClass("colx2"):4<k&&8>=k&&(d("#bistri-videos").removeClass("colx2"),d("#bistri-videos").addClass("colx3"));this._resizeVideos();
1<this._mediaCount(h.node(0))&&h.addClass("cascaded");d("#bistri-videos .screen-stream").count()&&d("#bistri-screen-sharing").addClass("disabled")},_removeStream:function(a,b){var c=d("#bistri-id-"+b);bc.detachStream(a);this._isPluginUsed&&d("#bistri-object-"+a.id.substr(0,8)).remove();this._mediaCount(c.node(0))?2>this._mediaCount(c.node(0))&&c.removeClass("cascaded"):(c.remove(),c=d("#bistri-videos > div").count(),4>=c&&2<=c?(d("#bistri-videos").removeClass("colx3"),d("#bistri-videos").addClass("colx2")):
2>c&&d("#bistri-videos").removeClass("colx2"));d("#bistri-videos .screen-stream").count()||d("#bistri-screen-sharing").removeClass("disabled");this._resizeVideos()},_resizeChat:function(){try{if(this._options.chat){var a=d("#bistri-chat").node(0).parentNode,b=d("#bistri-chat-messages").props().height,c=d(a).props().height,e=0;d("#"+a.id+" > *").foreach(function(a){a=d(a);e+=parseInt(a.style("height"))||a.props().height;e+=parseInt(a.getCss("margin-top"))+parseInt(a.getCss("margin-bottom"))});d("#bistri-chat-messages").style("height",
c-e+b+"px")}}catch(f){}},_resizeVideoFeedback:function(){try{var a=d("#bistri-videos-feedback"),b=parseInt(a.getCss("padding-left"))+parseInt(a.getCss("padding-right"));a.style("height",Math.round((a.props().width-b)/(4/3)+b)+"px")}catch(c){}},_resizeVideos:function(){try{d("#bistri-videos div[id^=bistri-id]").foreach(function(a){this._resizeVideo(a)}.bind(this))}catch(a){}},_resizeVideo:function(a){try{var b=d(a);if(b.node(0)){var c=parseInt(b.getCss("padding-left"))+parseInt(b.getCss("padding-right")),
e=Math.round((b.props().width-c)/(4/3)+c)+"px";b.style("height",e).addClass("full-height")}}catch(f){}},_hasVideoTracks:function(a){return!!a.getVideoTracks()&&!!a.getVideoTracks().length},_hasAudioTracks:function(a){return!!a.getAudioTracks()&&!!a.getAudioTracks().length},_mediaCount:function(a){return this._isPluginUsed?d("object",a).count():d("video",a).count()+d("audio",a).count()},_downloadPlugin:function(){var a=d("<div></div>").appendTo(d(".bistri-conference")).addClass("bistri-plugin"),b=
d("<div></div>").appendTo(a).addClass("bistri-plugin-buttons");d("<div>"+BISTRI_PLUGIN_TEXT+"</div>").appendTo(a).addClass("bistri-plugin-text");d("<a><span></span>"+BISTRI_PLUGIN_DOWNLOAD+"</a>").appendTo(b).on("click",function(){window.open(bc.getWebRTCPluginURL());a.remove()}).addClass("bistri-plugin-download");d("<a><span></span>"+BISTRI_PLUGIN_CANCEL+"</a>").appendTo(b).on("click",function(){a.remove()}).addClass("bistri-plugin-cancel")},_extensionInstallStarted:function(){d("<div></div>").appendTo(d(".bistri-conference")).addClass("bistri-extension-installing").html("<div>"+
BISTRI_EXTENSION_INSTALLATION+'<br/><span class="loader"></span></div>')},_extensionInstalled:function(){setTimeout(function(){d(".bistri-extension-installing").html('<div><span onclick="window.location.reload()" class="button">'+BISTRI_EXTENSION_RELOAD+"</span></div>")},3E3)}};window.addEventListener("load",function(){window.onBistriConferenceReady=function(){for(var a=d(".bistri-conference").node(0),b="",c=0;20>c;c++)b+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_".charAt(63*
Math.random());var b={appId:void 0,appKey:void 0,id:void 0,room:b,callee:void 0,name:void 0,device:"webcam-sd",debug:!1,extid:!1,"chrome-ext-id":!1,"firefox-ext-id":!1,"media-controls":!1,chat:!1,capacity:4},c=["appId","appKey"],e;if(a)for(var f in b)if(e=a.getAttribute("data-"+f))switch(!0){case /^true$/i.test(e):b[f]=!0;break;case /^false$/i.test(e):b[f]=!1;break;case /^[1-9]+$/i.test(e):b[f]=Number(e);break;default:b[f]=e}else"undefined"==typeof b[f]&&-1!=c.indexOf(f)&&console&&console.log&&console.log('Bistri Conference Widget: attribute "'+
f+'" is missing');l=new r(a,b)};p("css","https://api.bistri.com/bistri.conference.widget.css");p("js","https://api.bistri.com/bistri.conference.min.js")});window.addEventListener("resize",function(){l&&(n&&(clearTimeout(n),n=void 0),n=setTimeout(function(){l._resizeVideoFeedback();l._resizeVideo("#bistri-videos-feedback div[id^=bistri-id]");l._resizeVideos();l._resizeChat()},100))})})();
